<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Marketplace - Modern Pink</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                primary: '#ec4899',
                secondary: '#f472b6',
                dark: '#831843',
              }
            }
          }
        }
    </script>
    <style>
        body {
          background: linear-gradient(135deg, #fce7f3 0%, #f9a8d4 50%, #fbcfe8 100%);
          min-height: 100vh;
          font-family: 'Inter', system-ui, sans-serif;
        }
        .glass {
          background: rgba(255, 255, 255, 0.25);
          backdrop-filter: blur(12px);
          border: 1px solid rgba(255, 255, 255, 0.3);
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .btn-main {
          background: linear-gradient(90deg, #ec4899, #f472b6);
          box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
          transition: all 0.3s ease;
          cursor: pointer;
        }
        .btn-main:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(236, 72, 153, 0.6);
        }
        .fade-in {
          animation: fadeIn 0.6s ease-out forwards;
        }
        @keyframes fadeIn {
          from {opacity: 0; transform: translateY(15px);}
          to {opacity: 1; transform: translateY(0);}
        }
        .category-btn {
          background: white;
          color: #4b5563;
          cursor: pointer;
          transition: all 0.3s;
        }
        .category-btn:hover {
          background: #fce7f3;
        }
        .category-btn.active {
          background: linear-gradient(90deg, #ec4899, #f472b6);
          color: white;
          box-shadow: 0 4px 12px rgba(236, 72, 153, 0.4);
        }
        .dialog-overlay {
          animation: fadeInOverlay 0.3s ease-out;
        }
        @keyframes fadeInOverlay {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        .dialog-content {
          animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .tab-btn {
          cursor: pointer;
          transition: all 0.3s;
        }
        .tab-btn.active {
          border-bottom: 3px solid #ec4899;
          color: #ec4899;
        }
    </style>
</head>
<body>

<!-- Custom Dialog -->
<div id="customDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] p-4 dialog-overlay">
    <div class="glass rounded-3xl shadow-2xl w-full max-w-md p-6 dialog-content">
        <div class="text-center mb-4">
            <div id="dialogIcon" class="text-6xl mb-3"></div>
            <h3 id="dialogTitle" class="text-2xl font-bold text-gray-800 mb-2"></h3>
            <p id="dialogMessage" class="text-gray-600"></p>
        </div>
        <button id="dialogBtn" class="btn-main w-full py-3 rounded-xl text-white font-semibold">OK</button>
    </div>
</div>

<!-- Product Form Modal (Add/Edit) -->
<div id="productFormModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[90] p-4">
    <div class="glass w-full max-w-md p-6 rounded-3xl shadow-2xl">
        <div class="flex justify-between items-center mb-4">
            <h2 id="productFormTitle" class="text-2xl font-bold text-pink-600">Tambah Produk</h2>
            <button onclick="closeProductForm()" class="text-gray-600 hover:text-pink-600 text-3xl leading-none">&times;</button>
        </div>
        <div class="space-y-3">
            <input type="hidden" id="editProductId" />
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nama Produk</label>
                <input id="productName" type="text" class="w-full px-4 py-2 rounded-xl border-2 border-pink-200 focus:outline-none focus:border-pink-500" />
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Harga (Rp)</label>
                <input id="productPrice" type="number" class="w-full px-4 py-2 rounded-xl border-2 border-pink-200 focus:outline-none focus:border-pink-500" />
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Stok</label>
                <input id="productStock" type="number" class="w-full px-4 py-2 rounded-xl border-2 border-pink-200 focus:outline-none focus:border-pink-500" />
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                <select id="productCategory" class="w-full px-4 py-2 rounded-xl border-2 border-pink-200 focus:outline-none focus:border-pink-500">
                    <option value="elektronik">Elektronik</option>
                    <option value="fashion">Fashion</option>
                    <option value="makanan">Makanan</option>
                    <option value="alat-tulis">Alat Tulis</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Icon Emoji</label>
                <input id="productImage" type="text" placeholder="Contoh: üì±" class="w-full px-4 py-2 rounded-xl border-2 border-pink-200 focus:outline-none focus:border-pink-500" />
            </div>
            <button onclick="saveProduct()" class="btn-main w-full py-3 rounded-xl text-white font-semibold">Simpan Produk</button>
        </div>
    </div>
</div>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="flex items-center justify-center min-h-screen fade-in p-4">
    <div class="glass p-8 rounded-3xl shadow-2xl w-full max-w-md">
        <div class="text-center mb-6">
            <h1 class="text-4xl font-bold bg-gradient-to-r from-pink-500 to-rose-500 bg-clip-text text-transparent mb-2">üõçÔ∏è POS Marketplace</h1>
            <p class="text-gray-600">Silahkan login untuk melanjutkan</p>
        </div>
        <div class="space-y-4">
            <input id="loginUsername" type="text" placeholder="Username" class="w-full px-4 py-3 rounded-xl border-2 border-pink-200 focus:outline-none focus:border-pink-500 transition" />
            <input id="loginPassword" type="password" placeholder="Password" class="w-full px-4 py-3 rounded-xl border-2 border-pink-200 focus:outline-none focus:border-pink-500 transition" />
            <div class="flex items-center gap-2">
                <input id="rememberMe" type="checkbox" class="w-4 h-4 accent-pink-500" />
                <label for="rememberMe" class="text-sm text-gray-700">Simpan login saya</label>
            </div>
            <button id="btnLogin" class="btn-main w-full py-3 rounded-xl text-white font-semibold">Login</button>
            <button id="btnShowRegister" class="w-full py-3 border-2 border-pink-400 text-pink-600 rounded-xl hover:bg-pink-50 transition font-medium">Belum punya akun? Daftar</button>
            <div class="mt-4 p-4 bg-pink-50 rounded-xl text-xs text-gray-600">
                <p class="font-semibold mb-1">Demo Account:</p>
                <p>Admin: <code>admin</code> / <code>admin123</code></p>
                <p>User: <code>user</code> / <code>user123</code></p>
            </div>
        </div>
    </div>
</div>

<!-- REGISTER SCREEN -->
<div id="registerScreen" class="hidden flex items-center justify-center min-h-screen fade-in p-4">
    <div class="glass p-8 rounded-3xl shadow-2xl w-full max-w-md">
        <div class="text-center mb-6">
            <h1 class="text-4xl font-bold bg-gradient-to-r from-pink-500 to-rose-500 bg-clip-text text-transparent mb-2">üìù Daftar Akun</h1>
            <p class="text-gray-600">Buat akun baru untuk berbelanja</p>
        </div>
        <div class="space-y-3">
            <input id="regFullname" placeholder="Nama Lengkap" class="w-full px-4 py-3 rounded-xl border-2 border-pink-200 focus:outline-none focus:border-pink-500 transition" />
            <input id="regUsername" placeholder="Username" class="w-full px-4 py-3 rounded-xl border-2 border-pink-200 focus:outline-none focus:border-pink-500 transition" />
            <input id="regEmail" type="email" placeholder="Email" class="w-full px-4 py-3 rounded-xl border-2 border-pink-200 focus:outline-none focus:border-pink-500 transition" />
            <input id="regPassword" type="password" placeholder="Password (min. 6 karakter)" class="w-full px-4 py-3 rounded-xl border-2 border-pink-200 focus:outline-none focus:border-pink-500 transition" />
            <input id="regConfirmPassword" type="password" placeholder="Konfirmasi Password" class="w-full px-4 py-3 rounded-xl border-2 border-pink-200 focus:outline-none focus:border-pink-500 transition" />
            <button id="btnRegister" class="btn-main w-full py-3 rounded-xl text-white font-semibold mt-2">Daftar Sekarang</button>
            <button id="btnShowLogin" class="w-full py-3 border-2 border-pink-400 text-pink-600 rounded-xl hover:bg-pink-50 transition font-medium">Sudah punya akun? Login</button>
        </div>
    </div>
</div>

<!-- USER INTERFACE -->
<div id="userInterface" class="hidden fade-in">
    <nav class="glass sticky top-0 z-50 px-6 py-4 mb-6">
        <div class="flex justify-between items-center">
            <h2 class="text-2xl font-bold bg-gradient-to-r from-pink-500 to-rose-500 bg-clip-text text-transparent">üõçÔ∏è POS Marketplace</h2>
            <div class="flex items-center gap-3">
                <div class="hidden sm:flex items-center gap-2 px-4 py-2 bg-pink-50 rounded-xl">
                    <span class="text-2xl">üë§</span>
                    <div class="text-sm">
                        <p class="font-semibold text-gray-800" id="userName">User</p>
                        <p class="text-xs text-gray-500">Customer</p>
                    </div>
                </div>
                <button id="btnShowOrders" class="px-4 py-2 bg-pink-100 text-pink-700 rounded-xl font-medium hover:bg-pink-200 transition">üì¶ Pesanan</button>
                <button id="btnCart" class="btn-main px-4 py-2 rounded-xl text-white font-medium flex items-center gap-2">
                    üõí <span id="cartBadge" class="bg-white text-pink-600 px-2 py-0.5 rounded-full text-xs font-bold">0</span>
                </button>
                <button id="btnLogout" class="text-gray-600 hover:text-pink-600 transition text-2xl">üö™</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 pb-8">
        <input id="searchInput" type="text" placeholder="üîç Cari produk..." class="w-full px-6 py-4 mb-6 rounded-xl border-2 border-pink-200 focus:outline-none focus:border-pink-500 transition shadow-sm" />

        <div class="flex gap-3 mb-6 overflow-x-auto pb-2">
            <button class="category-btn active px-6 py-2 rounded-full font-medium whitespace-nowrap" data-cat="semua">Semua</button>
            <button class="category-btn px-6 py-2 rounded-full font-medium whitespace-nowrap" data-cat="elektronik">Elektronik</button>
            <button class="category-btn px-6 py-2 rounded-full font-medium whitespace-nowrap" data-cat="fashion">Fashion</button>
            <button class="category-btn px-6 py-2 rounded-full font-medium whitespace-nowrap" data-cat="makanan">Makanan</button>
            <button class="category-btn px-6 py-2 rounded-full font-medium whitespace-nowrap" data-cat="alat-tulis">Alat Tulis</button>
        </div>

        <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
    </div>
</div>

<!-- ADMIN INTERFACE -->
<div id="adminInterface" class="hidden fade-in p-6">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-3xl font-bold bg-gradient-to-r from-pink-500 to-rose-500 bg-clip-text text-transparent">üë®‚Äçüíº Admin Dashboard</h2>
            <p class="text-gray-600 mt-1">Selamat datang, <span id="adminName" class="font-semibold text-pink-600">Admin</span>!</p>
        </div>
        <button id="btnAdminLogout" class="flex items-center gap-2 px-4 py-2 text-gray-600 hover:text-pink-600 transition bg-pink-50 rounded-xl hover:bg-pink-100">
            <span class="font-medium">Logout</span>
            <span class="text-2xl">üö™</span>
        </button>
    </div>

    <!-- Tabs -->
    <div class="flex gap-4 mb-6 border-b-2 border-pink-100">
        <button onclick="switchTab('dashboard')" id="tabDashboard" class="tab-btn active px-4 py-2 font-semibold">üìä Dashboard</button>
        <button onclick="switchTab('products')" id="tabProducts" class="tab-btn px-4 py-2 font-semibold">üì¶ Kelola Produk</button>
        <button onclick="switchTab('orders')" id="tabOrders" class="tab-btn px-4 py-2 font-semibold">üõí Pesanan</button>
    </div>

    <!-- Dashboard Tab -->
    <div id="contentDashboard">
        <div class="grid lg:grid-cols-3 gap-4 mb-6">
            <div class="glass p-6 rounded-2xl text-center">
                <p class="text-gray-600 mb-2">Pesanan Pending</p>
                <h3 id="pendingCount" class="text-4xl text-yellow-600 font-bold">0</h3>
            </div>
            <div class="glass p-6 rounded-2xl text-center">
                <p class="text-gray-600 mb-2">Pesanan Selesai</p>
                <h3 id="completedCount" class="text-4xl text-green-500 font-bold">0</h3>
            </div>
            <div class="glass p-6 rounded-2xl text-center">
                <p class="text-gray-600 mb-2">Total Pendapatan</p>
                <h3 id="totalRevenue" class="text-3xl text-purple-600 font-bold">Rp 0</h3>
            </div>
        </div>
        <div class="glass p-6 rounded-2xl">
            <canvas id="chartSales"></canvas>
        </div>
    </div>

    <!-- Products Tab -->
    <div id="contentProducts" class="hidden">
        <div class="mb-4">
            <button onclick="openAddProduct()" class="btn-main px-6 py-3 rounded-xl text-white font-semibold">‚ûï Tambah Produk Baru</button>
        </div>
        <div id="productsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <!-- Orders Tab -->
    <div id="contentOrders" class="hidden">
        <div id="adminOrdersList" class="space-y-3"></div>
    </div>
</div>

<!-- CART MODAL -->
<div id="cartModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="glass w-full max-w-lg p-6 rounded-3xl shadow-2xl max-h-[90vh] overflow-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-pink-600">üõí Keranjang Belanja</h2>
            <button id="btnCloseCart" class="text-gray-600 hover:text-pink-600 text-3xl leading-none">&times;</button>
        </div>

        <div class="mb-4">
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="selectAllCart" class="w-5 h-5 accent-pink-500" />
                <span class="font-semibold text-gray-700">Pilih Semua</span>
            </label>
        </div>

        <div id="cartItems" class="space-y-3 mb-4"></div>
        <div class="border-t pt-4 mt-4">
            <div class="flex justify-between items-center mb-4">
                <span class="text-lg font-semibold">Total (<span id="selectedCount">0</span> item):</span>
                <span id="totalPrice" class="text-3xl font-bold bg-gradient-to-r from-pink-500 to-rose-500 bg-clip-text text-transparent">Rp 0</span>
            </div>
            <button id="btnCheckout" class="btn-main w-full py-3 rounded-xl text-white font-semibold">Checkout Item Terpilih</button>
        </div>
    </div>
</div>

<!-- USER ORDERS MODAL -->
<div id="ordersModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="glass w-full max-w-3xl p-6 rounded-3xl shadow-2xl max-h-[90vh] overflow-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-pink-600">üì¶ Pesanan Saya</h2>
            <button id="btnCloseOrders" class="text-gray-600 hover:text-pink-600 text-3xl leading-none">&times;</button>
        </div>
        <div id="ordersList" class="space-y-4"></div>
    </div>
</div>

<script>
    // Initialize products from localStorage or use default
    let products = JSON.parse(localStorage.getItem('products')) || [
      { id: 1, name: 'Laptop Gaming', price: 15000000, category: 'elektronik', stock: 5, image: 'üíª' },
      { id: 2, name: 'Smartphone Pro', price: 5000000, category: 'elektronik', stock: 10, image: 'üì±' },
      { id: 3, name: 'Headphone Wireless', price: 500000, category: 'elektronik', stock: 15, image: 'üéß' },
      { id: 4, name: 'Kaos Premium', price: 75000, category: 'fashion', stock: 50, image: 'üëï' },
      { id: 5, name: 'Celana Jeans', price: 250000, category: 'fashion', stock: 30, image: 'üëñ' },
      { id: 6, name: 'Sepatu Sneakers', price: 450000, category: 'fashion', stock: 20, image: 'üëü' },
      { id: 7, name: 'Kopi Arabica', price: 45000, category: 'makanan', stock: 100, image: '‚òï' },
      { id: 8, name: 'Roti Sandwich', price: 25000, category: 'makanan', stock: 40, image: 'ü•™' },
      { id: 9, name: 'Buku Tulis A5', price: 15000, category: 'alat-tulis', stock: 200, image: 'üìì' },
      { id: 10, name: 'Pulpen Set', price: 5000, category: 'alat-tulis', stock: 500, image: 'üñäÔ∏è' },
      { id: 11, name: 'Mouse Gaming RGB', price: 350000, category: 'elektronik', stock: 25, image: 'üñ±Ô∏è' },
      { id: 12, name: 'Tas Ransel', price: 350000, category: 'fashion', stock: 15, image: 'üéí' },
    ];

    // Save products to localStorage
    function saveProductsToStorage() {
      localStorage.setItem('products', JSON.stringify(products));
    }

    let currentUser = null;
    let cart = [];
    let currentCategory = 'semua';
    let chartInstance = null;

    // Elements
    const loginScreen = document.getElementById('loginScreen');
    const registerScreen = document.getElementById('registerScreen');
    const userInterface = document.getElementById('userInterface');
    const adminInterface = document.getElementById('adminInterface');
    const cartModal = document.getElementById('cartModal');
    const ordersModal = document.getElementById('ordersModal');

    // Custom Dialog Functions
    function showDialog(title, message, icon = '‚úÖ') {
      document.getElementById('dialogTitle').textContent = title;
      document.getElementById('dialogMessage').textContent = message;
      document.getElementById('dialogIcon').textContent = icon;
      document.getElementById('customDialog').classList.remove('hidden');
    }

    function closeDialog() {
      document.getElementById('customDialog').classList.add('hidden');
    }

    document.getElementById('dialogBtn').addEventListener('click', closeDialog);

    // Admin Tabs
    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('contentDashboard').classList.add('hidden');
      document.getElementById('contentProducts').classList.add('hidden');
      document.getElementById('contentOrders').classList.add('hidden');

      if (tab === 'dashboard') {
        document.getElementById('tabDashboard').classList.add('active');
        document.getElementById('contentDashboard').classList.remove('hidden');
        loadAdminDashboard();
      } else if (tab === 'products') {
        document.getElementById('tabProducts').classList.add('active');
        document.getElementById('contentProducts').classList.remove('hidden');
        renderAdminProducts();
      } else if (tab === 'orders') {
        document.getElementById('tabOrders').classList.add('active');
        document.getElementById('contentOrders').classList.remove('hidden');
        renderAdminOrders();
      }
    }

    // Product Management Functions
    function openAddProduct() {
      document.getElementById('productFormTitle').textContent = 'Tambah Produk Baru';
      document.getElementById('editProductId').value = '';
      document.getElementById('productName').value = '';
      document.getElementById('productPrice').value = '';
      document.getElementById('productStock').value = '';
      document.getElementById('productCategory').value = 'elektronik';
      document.getElementById('productImage').value = '';
      document.getElementById('productFormModal').classList.remove('hidden');
    }

    function openEditProduct(id) {
      const product = products.find(p => p.id === id);
      if (!product) return;

      document.getElementById('productFormTitle').textContent = 'Edit Produk';
      document.getElementById('editProductId').value = product.id;
      document.getElementById('productName').value = product.name;
      document.getElementById('productPrice').value = product.price;
      document.getElementById('productStock').value = product.stock;
      document.getElementById('productCategory').value = product.category;
      document.getElementById('productImage').value = product.image;
      document.getElementById('productFormModal').classList.remove('hidden');
    }

    function closeProductForm() {
      document.getElementById('productFormModal').classList.add('hidden');
    }

    function saveProduct() {
      const id = document.getElementById('editProductId').value;
      const name = document.getElementById('productName').value.trim();
      const price = parseInt(document.getElementById('productPrice').value);
      const stock = parseInt(document.getElementById('productStock').value);
      const category = document.getElementById('productCategory').value;
      const image = document.getElementById('productImage').value.trim() || 'üì¶';

      if (!name || !price || price < 0 || !stock || stock < 0) {
        return showDialog('Error', 'Mohon isi semua field dengan benar!', '‚ö†Ô∏è');
      }

      if (id) {
        // Edit existing product
        const product = products.find(p => p.id === parseInt(id));
        if (product) {
          product.name = name;
          product.price = price;
          product.stock = stock;
          product.category = category;
          product.image = image;
          showDialog('Berhasil', 'Produk berhasil diupdate!', '‚úÖ');
        }
      } else {
        // Add new product
        const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
        products.push({ id: newId, name, price, stock, category, image });
        showDialog('Berhasil', 'Produk baru berhasil ditambahkan!', '‚úÖ');
      }

      saveProductsToStorage();
      closeProductForm();
      renderAdminProducts();
    }

    function deleteProduct(id) {
      if (!confirm('Yakin ingin menghapus produk ini?')) return;

      products = products.filter(p => p.id !== id);
      saveProductsToStorage();
      showDialog('Berhasil', 'Produk berhasil dihapus!', '‚úÖ');
      renderAdminProducts();
    }

    function renderAdminProducts() {
      const list = document.getElementById('productsList');
      if (!products.length) {
        list.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-full">Belum ada produk</p>';
        return;
      }

      list.innerHTML = products.map(p => `
        <div class="glass p-5 rounded-2xl">
          <div class="text-5xl text-center mb-3">${p.image}</div>
          <h3 class="font-bold text-lg mb-1">${p.name}</h3>
          <p class="text-pink-600 font-bold text-xl mb-1">${formatPrice(p.price)}</p>
          <p class="text-sm text-gray-600 mb-1">Kategori: ${p.category}</p>
          <p class="text-sm ${p.stock < 10 ? 'text-red-600 font-semibold' : 'text-gray-600'} mb-3">Stok: ${p.stock}</p>
          <div class="flex gap-2">
            <button onclick="openEditProduct(${p.id})" class="flex-1 px-3 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition">‚úèÔ∏è Edit</button>
            <button onclick="deleteProduct(${p.id})" class="flex-1 px-3 py-2 bg-red-500 text-white rounded-xl hover:bg-red-600 transition">üóëÔ∏è Hapus</button>
          </div>
        </div>
      `).join('');
    }

    // Event Listeners - Login/Register
    document.getElementById('btnLogin').addEventListener('click', login);
    document.getElementById('btnShowRegister').addEventListener('click', () => {
      loginScreen.classList.add('hidden');
      registerScreen.classList.remove('hidden');
    });
    document.getElementById('btnRegister').addEventListener('click', register);
    document.getElementById('btnShowLogin').addEventListener('click', () => {
      registerScreen.classList.add('hidden');
      loginScreen.classList.remove('hidden');
    });

    // Event Listeners - User
    document.getElementById('btnLogout').addEventListener('click', logout);
    document.getElementById('btnCart').addEventListener('click', toggleCart);
    document.getElementById('btnCloseCart').addEventListener('click', toggleCart);
    document.getElementById('btnCheckout').addEventListener('click', checkout);
    document.getElementById('btnShowOrders').addEventListener('click', showOrders);
    document.getElementById('btnCloseOrders').addEventListener('click', () => ordersModal.classList.add('hidden'));
    document.getElementById('searchInput').addEventListener('input', renderProducts);

    // Select All Cart
    document.getElementById('selectAllCart').addEventListener('change', (e) => {
      const checkboxes = document.querySelectorAll('.cart-item-checkbox');
      checkboxes.forEach(cb => cb.checked = e.target.checked);
      updateCartTotal();
    });

    // Event Listeners - Admin
    document.getElementById('btnAdminLogout').addEventListener('click', logout);

    // Category buttons
    document.querySelectorAll('.category-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        currentCategory = e.target.getAttribute('data-cat');
        renderProducts();
      });
    });

    // Init
    document.addEventListener('DOMContentLoaded', checkAuth);

    // Auth Functions
    function login() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      const remember = document.getElementById('rememberMe').checked;

      if (!username || !password) {
        showDialog('Error', 'Username dan password wajib diisi!', '‚ö†Ô∏è');
        return;
      }

      if (username === 'admin' && password === 'admin123') {
        currentUser = { username: 'admin', role: 'admin', fullname: 'Administrator' };
      } else if (username === 'user' && password === 'user123') {
        currentUser = { username: 'user', role: 'user', fullname: 'Demo User' };
      } else {
        const users = JSON.parse(localStorage.getItem('users')) || [];
        const foundUser = users.find(u => u.username === username && u.password === password);

        if (!foundUser) {
          showDialog('Login Gagal', 'Username atau password salah!', '‚ùå');
          return;
        }

        currentUser = foundUser;
      }

      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      if (remember) localStorage.setItem('rememberUser', JSON.stringify(currentUser));

      if (currentUser.role === 'admin') showAdmin();
      else showUser();
    }

    function register() {
      const fullname = document.getElementById('regFullname').value.trim();
      const username = document.getElementById('regUsername').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value;
      const confirmPassword = document.getElementById('regConfirmPassword').value;

      if (fullname.length < 3) return showDialog('Error', 'Nama lengkap minimal 3 karakter!', '‚ö†Ô∏è');
      if (username.length < 4) return showDialog('Error', 'Username minimal 4 karakter!', '‚ö†Ô∏è');
      if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) return showDialog('Error', 'Email tidak valid!', '‚ö†Ô∏è');
      if (password.length < 6) return showDialog('Error', 'Password minimal 6 karakter!', '‚ö†Ô∏è');
      if (password !== confirmPassword) return showDialog('Error', 'Password tidak cocok!', '‚ö†Ô∏è');

      let users = JSON.parse(localStorage.getItem('users')) || [];
      if (users.find(u => u.username === username)) return showDialog('Error', 'Username sudah terdaftar!', '‚ö†Ô∏è');

      const newUser = {
        fullname,
        username,
        email,
        password,
        role: 'user',
        registeredAt: new Date().toISOString()
      };

      users.push(newUser);
      localStorage.setItem('users', JSON.stringify(users));

      showDialog('Berhasil!', 'Registrasi berhasil! Silakan login dengan username dan password yang sudah dibuat.', 'üéâ');

      document.getElementById('regFullname').value = '';
      document.getElementById('regUsername').value = '';
      document.getElementById('regEmail').value = '';
      document.getElementById('regPassword').value = '';
      document.getElementById('regConfirmPassword').value = '';

      setTimeout(() => {
        registerScreen.classList.add('hidden');
        loginScreen.classList.remove('hidden');
      }, 2000);
    }

    function logout() {
      currentUser = null;
      cart = [];
      localStorage.removeItem('currentUser');
      localStorage.removeItem('rememberUser');
      userInterface.classList.add('hidden');
      adminInterface.classList.add('hidden');
      loginScreen.classList.remove('hidden');
    }

    function checkAuth() {
      const remembered = localStorage.getItem('rememberUser');
      const stored = localStorage.getItem('currentUser');

      if (remembered) currentUser = JSON.parse(remembered);
      else if (stored) currentUser = JSON.parse(stored);
      else return;

      if (currentUser.role === 'admin') showAdmin();
      else showUser();
    }

    function showUser() {
      loginScreen.classList.add('hidden');
      registerScreen.classList.add('hidden');
      adminInterface.classList.add('hidden');
      userInterface.classList.remove('hidden');

      document.getElementById('userName').textContent = currentUser.fullname || currentUser.username;

      renderProducts();
      updateCartBadge();
    }

    function showAdmin() {
      loginScreen.classList.add('hidden');
      registerScreen.classList.add('hidden');
      userInterface.classList.add('hidden');
      adminInterface.classList.remove('hidden');

      document.getElementById('adminName').textContent = currentUser.fullname || currentUser.username;

      switchTab('dashboard');
    }

    // Product Functions
    function renderProducts() {
      const grid = document.getElementById('productGrid');
      const searchValue = document.getElementById('searchInput').value.toLowerCase();
      const filtered = products.filter(p =>
        (currentCategory === 'semua' || p.category === currentCategory) &&
        p.name.toLowerCase().includes(searchValue)
      );

      grid.innerHTML = filtered.map(p => `
        <div class="glass p-5 rounded-2xl hover:shadow-xl transition fade-in">
          <div class="text-6xl text-center mb-3">${p.image}</div>
          <h3 class="font-bold text-lg mb-1">${p.name}</h3>
          <p class="text-pink-600 font-bold text-xl mb-1">${formatPrice(p.price)}</p>
          <p class="text-xs text-gray-500 mb-3">Stok: ${p.stock}</p>
          <div class="flex gap-2">
            <button class="btn-main flex-1 py-2 rounded-xl text-white text-sm font-semibold" data-action="buy" data-id="${p.id}">‚ö° Beli</button>
            <button class="bg-white border-2 border-pink-300 flex-1 py-2 rounded-xl text-pink-600 text-sm font-semibold hover:bg-pink-50" data-action="cart" data-id="${p.id}">üõí +</button>
          </div>
        </div>
      `).join('');

      grid.querySelectorAll('[data-action="buy"]').forEach(btn => {
        btn.addEventListener('click', () => buyNow(parseInt(btn.getAttribute('data-id'))));
      });
      grid.querySelectorAll('[data-action="cart"]').forEach(btn => {
        btn.addEventListener('click', () => addToCart(parseInt(btn.getAttribute('data-id'))));
      });
    }

    function addToCart(id) {
      const p = products.find(x => x.id === id);
      if (!p || p.stock <= 0) return showDialog('Stok Habis', 'Produk tidak tersedia!', '‚ùå');

      const exist = cart.find(x => x.id === id);
      if (exist) exist.qty++;
      else cart.push({ ...p, qty: 1, selected: true });

      updateCartBadge();
      showDialog('Berhasil!', `${p.name} ditambahkan ke keranjang`, '‚úÖ');
    }

    function buyNow(id) {
      const p = products.find(x => x.id === id);
      if (!p || p.stock <= 0) return showDialog('Stok Habis', 'Produk tidak tersedia!', '‚ùå');

      const order = {
        id: 'ORD' + Date.now(),
        username: currentUser.username,
        date: new Date().toLocaleString('id-ID'),
        timestamp: Date.now(),
        items: [{ ...p, qty: 1 }],
        total: p.price,
        status: 'pending'
      };

      let orders = JSON.parse(localStorage.getItem('orders')) || [];
      orders.unshift(order);
      localStorage.setItem('orders', JSON.stringify(orders));

      showDialog('Pesanan Dibuat!', 'Pesanan berhasil dibuat! Menunggu persetujuan admin. Struk akan dikirim setelah pesanan disetujui.', 'üéâ');
    }

    function updateCartBadge() {
      document.getElementById('cartBadge').textContent = cart.reduce((s, i) => s + i.qty, 0);
    }

    function toggleCart() {
      cartModal.classList.toggle('hidden');
      if (!cartModal.classList.contains('hidden')) {
        renderCart();
      }
    }

    function renderCart() {
      const c = document.getElementById('cartItems');
      if (!cart.length) {
        c.innerHTML = '<p class="text-gray-500 text-center py-8">Keranjang kosong</p>';
        document.getElementById('totalPrice').textContent = 'Rp 0';
        document.getElementById('selectedCount').textContent = '0';
        return;
      }

      c.innerHTML = cart.map(i => `
        <div class="flex items-center gap-3 bg-pink-50 p-3 rounded-xl">
          <input type="checkbox" class="cart-item-checkbox w-5 h-5 accent-pink-500" data-id="${i.id}" ${i.selected ? 'checked' : ''} />
          <div class="flex-1">
            <p class="font-semibold">${i.image} ${i.name}</p>
            <p class="text-sm text-gray-600">${formatPrice(i.price)} x ${i.qty}</p>
          </div>
          <div class="flex items-center gap-2">
            <button class="bg-pink-300 hover:bg-pink-400 w-8 h-8 rounded-lg font-bold" data-action="dec" data-id="${i.id}">‚àí</button>
            <span class="font-bold w-8 text-center">${i.qty}</span>
            <button class="bg-pink-300 hover:bg-pink-400 w-8 h-8 rounded-lg font-bold" data-action="inc" data-id="${i.id}">+</button>
            <button class="text-red-500 hover:text-red-700 ml-2 text-xl font-bold" data-action="remove" data-id="${i.id}">√ó</button>
          </div>
        </div>
      `).join('');

      c.querySelectorAll('.cart-item-checkbox').forEach(cb => {
        cb.addEventListener('change', (e) => {
          const id = parseInt(e.target.getAttribute('data-id'));
          const item = cart.find(x => x.id === id);
          if (item) item.selected = e.target.checked;
          updateCartTotal();
        });
      });

      c.querySelectorAll('[data-action="inc"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = parseInt(btn.getAttribute('data-id'));
          const item = cart.find(x => x.id === id);
          const product = products.find(x => x.id === id);
          if (item && product && item.qty < product.stock) {
            item.qty++;
            renderCart();
            updateCartBadge();
          } else showDialog('Stok Habis', 'Stok tidak mencukupi!', '‚ö†Ô∏è');
        });
      });

      c.querySelectorAll('[data-action="dec"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = parseInt(btn.getAttribute('data-id'));
          const item = cart.find(x => x.id === id);
          if (item) {
            item.qty--;
            if (item.qty <= 0) cart = cart.filter(x => x.id !== id);
            renderCart();
            updateCartBadge();
          }
        });
      });

      c.querySelectorAll('[data-action="remove"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = parseInt(btn.getAttribute('data-id'));
          cart = cart.filter(x => x.id !== id);
          renderCart();
          updateCartBadge();
        });
      });

      updateCartTotal();
    }

    function updateCartTotal() {
      const selectedItems = cart.filter(i => i.selected);
      const total = selectedItems.reduce((s, i) => s + (i.price * i.qty), 0);
      const count = selectedItems.reduce((s, i) => s + i.qty, 0);

      document.getElementById('totalPrice').textContent = formatPrice(total);
      document.getElementById('selectedCount').textContent = count;
    }

    function checkout() {
      const selectedItems = cart.filter(i => i.selected);

      if (!selectedItems.length) {
        showDialog('Tidak Ada Item', 'Pilih minimal 1 item untuk checkout!', '‚ö†Ô∏è');
        return;
      }

      const order = {
        id: 'ORD' + Date.now(),
        username: currentUser.username,
        date: new Date().toLocaleString('id-ID'),
        timestamp: Date.now(),
        items: selectedItems.map(i => ({ ...i })),
        total: selectedItems.reduce((s, i) => s + (i.price * i.qty), 0),
        status: 'pending'
      };

      let orders = JSON.parse(localStorage.getItem('orders')) || [];
      orders.unshift(order);
      localStorage.setItem('orders', JSON.stringify(orders));

      cart = cart.filter(i => !i.selected);

      showDialog('Checkout Berhasil!', `${selectedItems.length} item berhasil di-checkout! Menunggu persetujuan admin.`, 'üéâ');

      renderCart();
      updateCartBadge();
      toggleCart();
    }

    function showOrders() {
      ordersModal.classList.remove('hidden');
      const orders = JSON.parse(localStorage.getItem('orders')) || [];
      const mine = orders.filter(o => o.username === currentUser.username);
      const list = document.getElementById('ordersList');

      if (!mine.length) {
        list.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada pesanan</p>';
        return;
      }

      list.innerHTML = mine.map(o => `
        <div class="glass p-5 rounded-2xl">
          <div class="flex justify-between items-start mb-3">
            <div>
              <p class="font-bold text-lg">${o.id}</p>
              <p class="text-sm text-gray-600">${o.date}</p>
            </div>
            <span class="px-3 py-1 rounded-full text-sm font-semibold ${o.status === 'pending' ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}">
              ${o.status === 'pending' ? '‚è≥ Diproses' : '‚úÖ Selesai'}
            </span>
          </div>
          <div class="text-sm mb-3">
            ${o.items.map(i => `${i.image} ${i.name} x${i.qty}`).join(', ')}
          </div>
          <div class="flex justify-between items-center">
            <span class="text-2xl font-bold text-pink-600">${formatPrice(o.total)}</span>
            ${o.status === 'completed' ? `<button class="btn-main px-4 py-2 rounded-xl text-white font-medium" onclick="printReceipt('${o.id}')">üñ® Cetak Struk</button>` : '<span class="text-sm text-gray-500">Struk akan tersedia setelah disetujui admin</span>'}
          </div>
        </div>
      `).join('');
    }

    function printReceipt(id) {
      const orders = JSON.parse(localStorage.getItem('orders')) || [];
      const o = orders.find(x => x.id === id);
      if (!o) return showDialog('Error', 'Order tidak ditemukan!', '‚ùå');
      if (o.status !== 'completed') return showDialog('Belum Disetujui', 'Pesanan belum disetujui admin!', '‚ö†Ô∏è');

      const win = window.open('', '_blank', 'width=400,height=600');
      win.document.write(`
        <html>
          <head>
            <title>Struk ${o.id}</title>
            <style>
              body { font-family: monospace; padding: 20px; }
              h3 { text-align: center; }
              hr { margin: 10px 0; }
            </style>
          </head>
          <body>
            <h3>üõçÔ∏è POS Marketplace</h3>
            <p><strong>ID:</strong> ${o.id}</p>
            <p><strong>Tanggal:</strong> ${o.date}</p>
            <p><strong>Customer:</strong> ${o.username}</p>
            <hr />
            ${o.items.map(i => `<div>${i.name} x${i.qty} - ${formatPrice(i.price * i.qty)}</div>`).join('')}
            <hr />
            <p><strong>Total:</strong> ${formatPrice(o.total)}</p>
            <p style="text-align:center; margin-top:30px;">Terima kasih atas pembelian Anda!</p>
            <p style="text-align:center; font-size:10px;">Pesanan telah disetujui dan diproses</p>
          </body>
        </html>
      `);
      win.document.close();
      win.print();
    }

    // Admin Functions
    function loadAdminDashboard() {
      const orders = JSON.parse(localStorage.getItem('orders')) || [];
      const pending = orders.filter(o => o.status === 'pending').length;
      const completed = orders.filter(o => o.status === 'completed').length;
      const revenue = orders.filter(o => o.status === 'completed').reduce((s, o) => s + o.total, 0);

      document.getElementById('pendingCount').textContent = pending;
      document.getElementById('completedCount').textContent = completed;
      document.getElementById('totalRevenue').textContent = formatPrice(revenue);

      renderChart(orders);
    }

    function renderAdminOrders() {
      const orders = JSON.parse(localStorage.getItem('orders')) || [];
      const list = document.getElementById('adminOrdersList');
      if (!orders.length) {
        list.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada pesanan</p>';
        return;
      }

      list.innerHTML = orders.map(o => `
        <div class="bg-white p-5 rounded-2xl border-2 ${o.status === 'pending' ? 'border-yellow-300' : 'border-green-300'}">
          <div class="flex justify-between items-start mb-2">
            <div>
              <p class="font-bold">${o.id}</p>
              <p class="text-sm text-gray-600">User: ${o.username} | ${o.date}</p>
            </div>
            <span class="px-3 py-1 rounded-full text-sm font-semibold ${o.status === 'pending' ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}">
              ${o.status === 'pending' ? '‚è≥ Pending' : '‚úÖ Selesai'}
            </span>
          </div>
          <p class="text-sm mb-2">${o.items.map(i => `${i.name} x${i.qty}`).join(', ')}</p>
          <div class="flex justify-between items-center">
            <span class="text-xl font-bold text-pink-600">${formatPrice(o.total)}</span>
            ${o.status === 'pending' ? `<button class="btn-main px-4 py-2 rounded-xl text-white font-medium" onclick="approveOrder('${o.id}')">‚úÖ Setujui & Kirim Struk</button>` : '<span class="text-sm text-green-600">‚úì Struk telah dikirim</span>'}
          </div>
        </div>
      `).join('');
    }

    function approveOrder(id) {
      let orders = JSON.parse(localStorage.getItem('orders')) || [];
      const idx = orders.findIndex(o => o.id === id);
      if (idx === -1) return;

      const order = orders[idx];
      orders[idx].status = 'completed';

      orders[idx].items.forEach(item => {
        const product = products.find(p => p.id === item.id);
        if (product) {
          product.stock = Math.max(0, product.stock - item.qty);
        }
      });

      saveProductsToStorage();
      localStorage.setItem('orders', JSON.stringify(orders));

      showDialog('Pesanan Disetujui!', `Pesanan ${id} telah disetujui! Struk sudah tersedia untuk user.`, '‚úÖ');

      printReceipt(id);

      renderAdminOrders();
      loadAdminDashboard();
    }

    function renderChart(orders) {
      const ctx = document.getElementById('chartSales').getContext('2d');
      if (chartInstance) chartInstance.destroy();

      const salesByDate = {};
      orders.filter(o => o.status === 'completed').forEach(o => {
        const d = o.date.split(',')[0];
        salesByDate[d] = (salesByDate[d] || 0) + o.total;
      });

      const labels = Object.keys(salesByDate).sort();
      const data = labels.map(d => salesByDate[d]);

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Penjualan (Rp)',
            data,
            backgroundColor: 'rgba(236, 72, 153, 0.2)',
            borderColor: 'rgba(236, 72, 153, 1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 5,
            pointBackgroundColor: 'rgba(236, 72, 153, 1)'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { callback: v => 'Rp ' + v.toLocaleString() }
            }
          }
        }
      });
    }

    function formatPrice(num) {
      return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
      }).format(num);
    }
</script>
</body>
</html>
